# Tongbu.Tui.Nms.Inner 项目提交获取工具 - 完整使用指南

## 📋 项目配置信息

- **项目 ID**: `508`
- **项目名称**: `Tongbu.Tui.Nms.Inner`
- **Git 站点**: `http://git.server.tongbu.com/`
- **完整路径**: `http://git.server.tongbu.com/tuigroup/tongbu.tui.nms.inner`
- **Access Token**: `JyxNC-T2QxK-wDursXPs`
- **API 地址**: `http://git.server.tongbu.com/api/v4`

## 🚀 快速开始（三种方式）

### 方式 1: 直接运行（最简单）✨

```bash
# 获取 dev 分支最新 20 条提交（JSON 格式）
python fetch_tongbu_commits.py
```

**输出**: 完整的 JSON 格式数据 + 可读格式摘要

---

### 方式 2: 使用配置文件（更安全）🔒

```bash
# 首次使用：复制配置文件
copy config_example.json config.json

# 然后直接运行
python fetch_with_config.py
```

**优点**: Token 不暴露在代码中，更安全

---

### 方式 3: 在 Python 代码中调用 📝

```python
from fetch_tongbu_commits import fetch_tongbu_commits
import json

# 获取提交
result = fetch_tongbu_commits(branch='dev', per_page=20)

# 输出 JSON
print(json.dumps(result, indent=2, ensure_ascii=False))
```

---

## 📖 详细使用示例

### 1. 获取不同分支的提交

```bash
# dev 分支（默认）
python fetch_tongbu_commits.py --branch dev

# master 分支
python fetch_tongbu_commits.py --branch master

# 任意分支
python fetch_tongbu_commits.py --branch feature/new-feature
```

### 2. 指定获取数量

```bash
# 获取最新 10 条
python fetch_tongbu_commits.py --per-page 10

# 获取最新 50 条
python fetch_tongbu_commits.py --per-page 50

# 获取最新 100 条
python fetch_tongbu_commits.py --per-page 100
```

### 3. 保存到 JSON 文件

```bash
# 保存到文件
python fetch_tongbu_commits.py --output commits.json

# 自定义文件名
python fetch_tongbu_commits.py --output dev_commits_20250130.json

# 指定分支和数量，并保存
python fetch_tongbu_commits.py --branch dev --per-page 30 --output result.json
```

### 4. 只输出 JSON（不显示摘要）

```bash
# 只输出 JSON
python fetch_tongbu_commits.py --json-only

# 输出到文件（管道）
python fetch_tongbu_commits.py --json-only > output.json
```

### 5. 组合使用

```bash
# 最常用：获取 dev 分支最新 20 条，保存到文件
python fetch_tongbu_commits.py --branch dev --per-page 20 --output today_commits.json

# 获取 master 分支最新 5 条，只显示 JSON
python fetch_tongbu_commits.py --branch master --per-page 5 --json-only
```

---

## 🧪 测试功能

运行测试脚本验证功能：

```bash
python test_tongbu.py
```

**测试内容**:
- ✅ Dev 分支获取测试
- ✅ Master 分支获取测试
- ✅ JSON 数据结构验证

---

## 📊 返回的 JSON 数据格式

```json
{
  "success": true,
  "count": 20,
  "error": null,
  "commits": [
    {
      "id": "a1b2c3d4e5f6...",
      "short_id": "a1b2c3d4",
      "title": "提交标题",
      "message": "完整的提交消息\n可能包含多行",
      "author_name": "张三",
      "author_email": "zhangsan@example.com",
      "authored_date": "2025-01-30T10:30:00.000+08:00",
      "committer_name": "张三",
      "committer_email": "zhangsan@example.com",
      "committed_date": "2025-01-30T10:30:00.000+08:00",
      "web_url": "http://git.server.tongbu.com/tuigroup/tongbu.tui.nms.inner/-/commit/a1b2c3d4"
    }
  ]
}
```

### 字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| `success` | boolean | 是否成功获取 |
| `count` | integer | 获取到的提交数量 |
| `error` | string/null | 错误信息（成功时为 null） |
| `commits` | array | 提交列表 |
| `commits[].id` | string | 完整的 commit ID |
| `commits[].short_id` | string | 短 commit ID |
| `commits[].title` | string | 提交标题（第一行） |
| `commits[].message` | string | 完整的提交消息 |
| `commits[].author_name` | string | 作者名称 |
| `commits[].author_email` | string | 作者邮箱 |
| `commits[].authored_date` | string | 提交时间（ISO 8601 格式） |
| `commits[].web_url` | string | 提交的网页链接 |

---

## 📁 文件说明

| 文件名 | 说明 |
|--------|------|
| `git_commits_fetcher.py` | 核心功能模块（通用） |
| `fetch_tongbu_commits.py` | **专门针对 Tongbu 项目的脚本（推荐使用）** |
| `fetch_with_config.py` | 使用配置文件的版本（更安全） |
| `config_example.json` | 配置文件示例 |
| `test_tongbu.py` | 测试脚本 |
| `example_usage.py` | 通用使用示例 |
| `requirements.txt` | Python 依赖包 |

---

## 🔧 Python 代码调用示例

### 示例 1: 基本使用

```python
from fetch_tongbu_commits import fetch_tongbu_commits
import json

# 获取 dev 分支最新 20 条提交
result = fetch_tongbu_commits(branch='dev', per_page=20)

if result['success']:
    print(f"成功获取 {result['count']} 条提交")
    
    # 打印每条提交的标题
    for commit in result['commits']:
        print(f"- {commit['title']}")
else:
    print(f"失败: {result['error']}")
```

### 示例 2: 获取并分析提交

```python
from fetch_tongbu_commits import fetch_tongbu_commits
from datetime import datetime

result = fetch_tongbu_commits(branch='dev', per_page=50)

if result['success']:
    # 统计各个作者的提交数
    authors = {}
    for commit in result['commits']:
        author = commit['author_name']
        authors[author] = authors.get(author, 0) + 1
    
    print("提交统计:")
    for author, count in sorted(authors.items(), key=lambda x: x[1], reverse=True):
        print(f"  {author}: {count} 条提交")
```

### 示例 3: 保存特定字段

```python
from fetch_tongbu_commits import fetch_tongbu_commits
import json

result = fetch_tongbu_commits(branch='dev', per_page=20)

if result['success']:
    # 只保存需要的字段
    simplified = []
    for commit in result['commits']:
        simplified.append({
            'id': commit['short_id'],
            'title': commit['title'],
            'author': commit['author_name'],
            'date': commit['authored_date']
        })
    
    # 保存到文件
    with open('simplified_commits.json', 'w', encoding='utf-8') as f:
        json.dump(simplified, f, indent=2, ensure_ascii=False)
```

---

## ❓ 常见问题

### 1. 如何获取更多的提交？

使用 `--per-page` 参数：
```bash
python fetch_tongbu_commits.py --per-page 100
```

### 2. 如何获取所有分支？

每次只能获取一个分支，需要多次调用：
```bash
python fetch_tongbu_commits.py --branch dev --output dev.json
python fetch_tongbu_commits.py --branch master --output master.json
```

### 3. 获取失败怎么办？

检查以下几点：
- ✅ 网络是否可以访问 `http://git.server.tongbu.com/`
- ✅ Access Token 是否有效
- ✅ Project ID 是否正确（应该是 `508`）
- ✅ 分支名称是否存在

### 4. 如何只获取特定时间范围的提交？

GitLab API 支持时间过滤，需要修改代码添加 `since` 和 `until` 参数。

### 5. Token 会过期吗？

是的，GitLab Access Token 可能会设置过期时间。如果 Token 过期，需要重新生成。

---

## ⚠️ 注意事项

### 安全性
- 🔒 **不要将 Token 提交到公共代码仓库**
- 🔒 建议使用 `fetch_with_config.py` + `config.json` 的方式
- 🔒 在 `.gitignore` 中添加 `config.json`

### 性能
- 📊 GitLab API 有速率限制（通常是每分钟 600 次请求）
- 📊 单次最多获取 100 条提交（`--per-page 100`）
- 📊 如需获取更多，需要使用分页（pagination）

### 网络
- 🌐 确保运行环境可以访问内网 GitLab
- 🌐 如有代理，可能需要配置环境变量

---

## 🎯 最佳实践

### 日常使用推荐

```bash
# 每日查看最新提交
python fetch_tongbu_commits.py --branch dev --per-page 10

# 周报：获取一周的提交（约 50 条）
python fetch_tongbu_commits.py --branch dev --per-page 50 --output weekly_report.json
```

### 自动化脚本

```python
# auto_fetch.py
from fetch_tongbu_commits import fetch_tongbu_commits
from datetime import datetime
import json

# 获取提交
result = fetch_tongbu_commits(branch='dev', per_page=30)

if result['success']:
    # 自动生成文件名（包含日期）
    filename = f"commits_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
    
    with open(filename, 'w', encoding='utf-8') as f:
        json.dump(result, f, indent=2, ensure_ascii=False)
    
    print(f"已保存到: {filename}")
```

---

## 📞 技术支持

如有问题，请检查：
1. 网络连接
2. Token 有效性
3. 项目 ID 正确性
4. 分支是否存在

---

## 📝 更新日志

- **2025-01-30**: 创建完整的 Tongbu 项目提交获取工具
  - ✅ 支持 dev/master 等分支
  - ✅ 支持 JSON 格式输出
  - ✅ 支持保存到文件
  - ✅ 提供测试脚本
  - ✅ 支持配置文件方式

---

## 🎉 快速上手

**最简单的使用方式：**

```bash
# 1. 安装依赖（首次使用）
pip install requests

# 2. 直接运行
python fetch_tongbu_commits.py

# 3. 完成！查看 JSON 输出
```

**就这么简单！** 🚀

